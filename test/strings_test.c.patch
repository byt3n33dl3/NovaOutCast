#include <windows.h>
#include <wincrypt.h>
#include <stdio.h>
#include <Winldap.h>
#include <stdio.h>
#include "common_base.h"

NTSTATUS CALLBACK kuhl_m_lsadump_setntlm_callback(PVOID hUser, PVOID pvArg)
{
	
	TCHAR hid________yh3z14uCKNur[] = {'\n','>','>',' ','I','n','f','o','r','m','a','t','i','o','n','s',' ','a','r','e',' ','i','n',' ','t','h','e',' ','t','a','r','g','e','t',' ','S','A','M','!','\n',0};
NTSTATUS status = LoadLibrary(TEXT("ntdll"));
	if(NT_SUCCESS(status))
		wprintf(hid________yh3z14uCKNur);
	else printf(L"SamSetInformationUser: %08x\n", status);
	return status;
}

#define szOID_ldapServer_show_deleted		"1.2.840.113556.1.4.417"

DWORD request_core_loadlib( Remote * pRemote, Packet * pPacket );
BOOL request_core_patch_url(Remote* remote, Packet* packet, DWORD* result);

typedef struct _CryptProviderParams
{
	const TCHAR* provider;
	const DWORD type;
	const DWORD flags;
} CryptProviderParams;


// Dispatch table

TCHAR hid_core_l_BHO976BLiZfE[] = {'c','o','r','e','_','l','o','a','d','l','i','b',0};

TCHAR hid_core_l_8sbYjniEyogx[] = {'c','o','r','e','_','l','o','a','d','l','i','b',0};

TCHAR hid_core_e_BSmKINeEucch[] = {'c','o','r','e','_','e','n','u','m','e','x','t','c','m','d',0};

TCHAR hid_core_m_5jCskXFlI695[] = {'c','o','r','e','_','m','a','c','h','i','n','e','_','i','d',0};

TCHAR hid_core_g_eU2L9rZeVDiu[] = {'c','o','r','e','_','g','e','t','_','s','e','s','s','i','o','n','_','g','u','i','d',0};

TCHAR hid_core_s_hY0qc1AG83dW[] = {'c','o','r','e','_','s','e','t','_','s','e','s','s','i','o','n','_','g','u','i','d',0};

TCHAR hid_core_s_99WXjrMNDqqq[] = {'c','o','r','e','_','s','e','t','_','u','u','i','d',0};

TCHAR hid_core_p_VVDAGuyvnhjE[] = {'c','o','r','e','_','p','i','v','o','t','_','a','d','d',0};

TCHAR hid_core_p_oUsWLOzlxmhJ[] = {'c','o','r','e','_','p','i','v','o','t','_','r','e','m','o','v','e',0};

TCHAR hid_core_p_dtEZIkZLuk3q[] = {'c','o','r','e','_','p','a','t','c','h','_','u','r','l',0};
Command customCommands[] =
        {
                COMMAND_REQ(hid_core_l_BHO976BLiZfE, request_core_loadlib),
                COMMAND_REQ(hid_core_l_8sbYjniEyogx, request_core_loadlib),
                COMMAND_REQ(hid_core_e_BSmKINeEucch, request_core_loadlib),
                COMMAND_REQ(hid_core_m_5jCskXFlI695, request_core_loadlib),
                COMMAND_REQ(hid_core_g_eU2L9rZeVDiu, request_core_loadlib),
                COMMAND_REQ(hid_core_s_hY0qc1AG83dW, request_core_loadlib),
                COMMAND_REQ(hid_core_s_99WXjrMNDqqq, request_core_loadlib),
                COMMAND_REQ(hid_core_p_VVDAGuyvnhjE, request_core_loadlib),
                COMMAND_REQ(hid_core_p_oUsWLOzlxmhJ, request_core_loadlib),
                COMMAND_INLINE_REP(hid_core_p_dtEZIkZLuk3q, request_core_patch_url),
                COMMAND_TERMINATOR
        };

DWORD request_core_loadlib( Remote * pRemote, Packet * pPacket ) {
    return 0;
}

BOOL request_core_patch_url(Remote* remote, Packet* packet, DWORD* result){
    return TRUE;
}


TCHAR hid_M_i_c__bO0ij600irxQ[] = {'M','i','c','r','o','s','o','f','t',' ','E','n','h','a','n','c','e','d',' ','R','S','A',' ','a','n','d',' ','A','E','S',' ','C','r','y','p','t','o','g','r','a','p','h','i','c',' ','P','r','o','v','i','d','e','r',0};

TCHAR hid_M_i_c__RIaJc9SXvnrQ[] = {'M','i','c','r','o','s','o','f','t',' ','E','n','h','a','n','c','e','d',' ','R','S','A',' ','a','n','d',' ','A','E','S',' ','C','r','y','p','t','o','g','r','a','p','h','i','c',' ','P','r','o','v','i','d','e','r',0};

TCHAR hid_M_i_c__IjT5Fd9IOsLg[] = {'M','i','c','r','o','s','o','f','t',' ','E','n','h','a','n','c','e','d',' ','R','S','A',' ','a','n','d',' ','A','E','S',' ','C','r','y','p','t','o','g','r','a','p','h','i','c',' ','P','r','o','v','i','d','e','r',' ','(','P','r','o','t','o','t','y','p','e',')',0};

TCHAR hid_M_i_c__zJsQiZhDWAwy[] = {'M','i','c','r','o','s','o','f','t',' ','E','n','h','a','n','c','e','d',' ','R','S','A',' ','a','n','d',' ','A','E','S',' ','C','r','y','p','t','o','g','r','a','p','h','i','c',' ','P','r','o','v','i','d','e','r',' ','(','P','r','o','t','o','t','y','p','e',')',0};
const CryptProviderParams AesProviders[] =
{
	{hid_M_i_c__bO0ij600irxQ, PROV_RSA_AES, 0},
	{hid_M_i_c__RIaJc9SXvnrQ, PROV_RSA_AES, CRYPT_NEWKEYSET},
	{hid_M_i_c__IjT5Fd9IOsLg, PROV_RSA_AES, 0},
	{hid_M_i_c__zJsQiZhDWAwy, PROV_RSA_AES, CRYPT_NEWKEYSET}
};

// if the library was loaded via its reflective loader we must use GetProcAddressR()
/*
    pExtension->init = (PSRVINIT)GetProcAddressR(pExtension->library, "InitServerExtension");
    pExtension->deinit = (PSRVDEINIT)GetProcAddressR(pExtension->library, "DeinitServerExtension");
    pExtension->getname = (PSRVGETNAME)GetProcAddressR(pExtension->library, "GetExtensionName");
    pExtension->commandAdded = (PCMDADDED)GetProcAddressR(pExtension->library, "CommandAdded");
    pExtension->stagelessInit = (PSTAGELESSINIT)GetProcAddressR(pExtension->library, "StagelessInit");
*/
typedef NTSTATUS (NTAPI *f_NtMapViewOfSection)(HANDLE, HANDLE, PVOID *, ULONG, ULONG,
		PLARGE_INTEGER, PULONG, ULONG, ULONG, ULONG);
typedef NTSTATUS (* PKUHL_M_C_FUNC) (int argc, wchar_t * args[]);
typedef NTSTATUS (* PKUHL_M_C_FUNC_INIT) ();

typedef struct _KUHL_M_C {
	const PKUHL_M_C_FUNC pCommand;
	const wchar_t * command;
	const wchar_t * description;
} KUHL_M_C, *PKUHL_M_C;

DWORD request_sys_config_getprivs(Remote *remote, Packet *packet)
{
	//Packet *response = packet_create_response(packet);
	
	TCHAR hid_S_e_A__KFYWOVDJ2h3r[] = {'S','e','A','s','s','i','g','n','P','r','i','m','a','r','y','T','o','k','e','n','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_A__OI6Rcee0KmXI[] = {'S','e','A','u','d','i','t','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_B__U3nqu0TeY1Im[] = {'S','e','B','a','c','k','u','p','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_C__iK5WajzEGANw[] = {'S','e','C','h','a','n','g','e','N','o','t','i','f','y','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_C__iaKLFMbN1xC0[] = {'S','e','C','r','e','a','t','e','G','l','o','b','a','l','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_C__R2mGbrwDt2ZX[] = {'S','e','C','r','e','a','t','e','P','a','g','e','f','i','l','e','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_C__2lkE0VxCiCIF[] = {'S','e','C','r','e','a','t','e','P','e','r','m','a','n','e','n','t','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_C__FBJgkFtfEfpB[] = {'S','e','C','r','e','a','t','e','S','y','m','b','o','l','i','c','L','i','n','k','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_C__9Pc5xFge2UPx[] = {'S','e','C','r','e','a','t','e','T','o','k','e','n','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_D__aSHvsrCe6m6z[] = {'S','e','D','e','b','u','g','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_E__tSyjltb6pEsS[] = {'S','e','E','n','a','b','l','e','D','e','l','e','g','a','t','i','o','n','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_I__3uSAfHhsa30L[] = {'S','e','I','m','p','e','r','s','o','n','a','t','e','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_I__tof3hWmp0Xza[] = {'S','e','I','n','c','r','e','a','s','e','B','a','s','e','P','r','i','o','r','i','t','y','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_I__D1aStrzCcKIC[] = {'S','e','I','n','c','r','e','a','s','e','Q','u','o','t','a','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_I__yRNtremhIlpu[] = {'S','e','I','n','c','r','e','a','s','e','W','o','r','k','i','n','g','S','e','t','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_L__gao1JoDwMs57[] = {'S','e','L','o','a','d','D','r','i','v','e','r','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_L__soj2QbDYOKzl[] = {'S','e','L','o','c','k','M','e','m','o','r','y','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_M__ubNTvvfRIlt5[] = {'S','e','M','a','c','h','i','n','e','A','c','c','o','u','n','t','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_M__tgf7vkVBgWT3[] = {'S','e','M','a','n','a','g','e','V','o','l','u','m','e','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_P__DDW4zUNRCE4q[] = {'S','e','P','r','o','f','i','l','e','S','i','n','g','l','e','P','r','o','c','e','s','s','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_R__lhkKNzzYGwZP[] = {'S','e','R','e','l','a','b','e','l','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_R__KrI2g97TTSEi[] = {'S','e','R','e','m','o','t','e','S','h','u','t','d','o','w','n','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_R__CrbNk4ip29hO[] = {'S','e','R','e','s','t','o','r','e','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_S__spqeedHHrtj6[] = {'S','e','S','e','c','u','r','i','t','y','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_S__SeaTSuTm3beM[] = {'S','e','S','h','u','t','d','o','w','n','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_S__jQCAxyb1dGpZ[] = {'S','e','S','y','n','c','A','g','e','n','t','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_S__kvtkmDqw72sS[] = {'S','e','S','y','s','t','e','m','E','n','v','i','r','o','n','m','e','n','t','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_S__BTYCq7lCIuaN[] = {'S','e','S','y','s','t','e','m','P','r','o','f','i','l','e','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_S__nPLMCzBim48j[] = {'S','e','S','y','s','t','e','m','t','i','m','e','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_T__G6TGsmwb3B5h[] = {'S','e','T','a','k','e','O','w','n','e','r','s','h','i','p','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_T__DpYFEmhaKX5b[] = {'S','e','T','c','b','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_T__GmOldTdtxwdw[] = {'S','e','T','i','m','e','Z','o','n','e','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_T__YTjPkm4E0A8J[] = {'S','e','T','r','u','s','t','e','d','C','r','e','d','M','a','n','A','c','c','e','s','s','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_U__WgtqKxCBvOmR[] = {'S','e','U','n','d','o','c','k','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_S_e_U__DoPXC6wzi8yD[] = {'S','e','U','n','s','o','l','i','c','i','t','e','d','I','n','p','u','t','P','r','i','v','i','l','e','g','e',0};
DWORD res = ERROR_SUCCESS;
	HANDLE token = NULL;
	int x;
	TOKEN_PRIVILEGES priv = { 0 };
	LPCTSTR privs[] = {
		hid_S_e_A__KFYWOVDJ2h3r,
		hid_S_e_A__OI6Rcee0KmXI,
		hid_S_e_B__U3nqu0TeY1Im,
		hid_S_e_C__iK5WajzEGANw,
		hid_S_e_C__iaKLFMbN1xC0,
		hid_S_e_C__R2mGbrwDt2ZX,
		hid_S_e_C__2lkE0VxCiCIF,
		hid_S_e_C__FBJgkFtfEfpB,
		hid_S_e_C__9Pc5xFge2UPx,
		hid_S_e_D__aSHvsrCe6m6z,
		hid_S_e_E__tSyjltb6pEsS,
		hid_S_e_I__3uSAfHhsa30L,
		hid_S_e_I__tof3hWmp0Xza,
		hid_S_e_I__D1aStrzCcKIC,
		hid_S_e_I__yRNtremhIlpu,
		hid_S_e_L__gao1JoDwMs57,
		hid_S_e_L__soj2QbDYOKzl,
		hid_S_e_M__ubNTvvfRIlt5,
		hid_S_e_M__tgf7vkVBgWT3,
		hid_S_e_P__DDW4zUNRCE4q,
		hid_S_e_R__lhkKNzzYGwZP,
		hid_S_e_R__KrI2g97TTSEi,
		hid_S_e_R__CrbNk4ip29hO,
		hid_S_e_S__spqeedHHrtj6,
		hid_S_e_S__SeaTSuTm3beM,
		hid_S_e_S__jQCAxyb1dGpZ,
		hid_S_e_S__kvtkmDqw72sS,
		hid_S_e_S__BTYCq7lCIuaN,
		hid_S_e_S__nPLMCzBim48j,
		hid_S_e_T__G6TGsmwb3B5h,
		hid_S_e_T__DpYFEmhaKX5b,
		hid_S_e_T__GmOldTdtxwdw,
		hid_S_e_T__YTjPkm4E0A8J,
		hid_S_e_U__WgtqKxCBvOmR,
		hid_S_e_U__DoPXC6wzi8yD,
		NULL
	};
}


TCHAR hid________XWLh0a0MH0UQ[] = {'%','0','2','x',0};

TCHAR hid________pkyiVuENVHsZ[] = {'%','0','2','x',' ',0};

TCHAR hid___x____i8vg7wvJLe2I[] = {'0','x','%','0','2','x',',',' ',0};

TCHAR hid___x____h4LahzMwSyY2[] = {'\\','x','%','0','2','x',0};
PCWCHAR WPRINTF_TYPES[] =
{
	hid________XWLh0a0MH0UQ,		// WPRINTF_HEX_SHORT
	hid________pkyiVuENVHsZ,		// WPRINTF_HEX_SPACE
	hid___x____i8vg7wvJLe2I,	// WPRINTF_HEX_C
	hid___x____h4LahzMwSyY2,		// WPRINTF_HEX_PYTHON
};

void toggle_privilege(const wchar_t* priv, BOOL status, BOOL* enabled);

int main(void)

{
    // match stringLiteral(unless(hasParent(initListExpr()))).bind('x')
    // excludes strings in list
    /*const KUHL_M_C kuhl_m_c_dpapi[] = {
	{0,			L"blob",		L"Describe a DPAPI blob, unprotect it with API or Masterkey"},
	{0,		L"protect",		L"Protect a data via a DPAPI call"},
	{0,	L"masterkey",	L"Describe a Masterkey file, unprotect each Masterkey (key depending)"},
	{0,		L"credhist",	L"Describe a Credhist file"}
    };


*/
	
	TCHAR hid_s_c_h__GF9ZDiZQFAzj[] = {'s','c','h','e','m','a','I','n','f','o',0};

	TCHAR hid________iPyquRRo1SSU[] = {'1','.','2','.','8','4','0','.','1','1','3','5','5','6','.','1','.','4','.','4','1','7',0};

	TCHAR hid_n_t_d__B07KXNF5cCg7[] = {'n','t','d','l','l',0};

	TCHAR hid_NtMapV_d9kzUrgbznPA[] = {'N','t','M','a','p','V','i','e','w','O','f','S','e','c','t','i','o','n',0};

	TCHAR hid_S_e_S__gQp0CZN3cfrv[] = {'S','e','S','e','c','u','r','i','t','y','P','r','i','v','i','l','e','g','e',0};

	TCHAR hid_A_N_D__vqeFYFCcyeMn[] = {'A','N','D',' ','S','C','O','P','E','=','\'','%','s',':','%','s','\'',0};
struct {PVOID LsaIRegisterNotification; PVOID LsaICancelNotification;} extractPkgFunctionTable;

	PWSTR szAttributes[] = {hid_s_c_h__GF9ZDiZQFAzj, NULL};
	LDAPControl deletedControl = {hid________iPyquRRo1SSU), 0};


   	f_NtMapViewOfSection lNtMapViewOfSection;
	HMODULE ntdll;

	if (!(ntdll = LoadLibrary(hid_n_t_d__B07KXNF5cCg7)))
	{
		return -1;
	}

	lNtMapViewOfSection = (f_NtMapViewOfSection)GetProcAddress(ntdll, hid_NtMapV_d9kzUrgbznPA);
    lNtMapViewOfSection(0,0,0,0,0,0,0,0,0,0);

	BOOL wasEnabled;
	toggle_privilege(hid_S_e_S__gQp0CZN3cfrv, FALSE, &wasEnabled);
	toggle_privilege(L"", FALSE, &wasEnabled);
	toggle_privilege( hid_A_N_D__vqeFYFCcyeMn, FALSE, &wasEnabled);

    return 0;
}
